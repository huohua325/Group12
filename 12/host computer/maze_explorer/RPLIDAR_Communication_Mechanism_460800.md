# RPLIDAR S&C Series Communication Mechanism Details (for STM32F466, Baud Rate 460800)

> Document Version: v2.8 (organized based on "RPLIDAR Communication Interface Protocol and Application Manual")  
> Target Purpose: Provide technical basis for STM32F466 or other MCU UART communication and data parsing logic  
> Baud Rate: **460800 bps**  
> Device Interface: TTL UART  
> Communication Direction: Host(MCU) ←→ RPLIDAR ranging core  

---

## 1. Communication Framework Overview

RPLIDAR communicates bidirectionally with external hosts (such as STM32, PC, etc.) through **UART serial port (TTL level)**.  
The communication process is based on **master-slave mode**: all sessions are initiated by the MCU, and RPLIDAR only returns corresponding data after receiving valid requests.  

### Features:
- Transmission Format: **Binary Data Packets**
- Byte Order: **Little Endian (low byte first)**
- Physical Layer: TTL UART Signal
- Baud Rate: 460800 bps (fixed)
- No parity, 8 data bits, 1 stop bit (8N1)
- No flow control (RTS/CTS disabled)

---

## 2. Communication Roles and Data Flow Direction

| Direction | Description |
|------|------|
| MCU → RPLIDAR | Send command request packets (Request) |
| RPLIDAR → MCU | Return response packets (Response), or send continuous sampling data stream in scanning state |

### Packet Types

1. **Request Packets**  
   - Initiated actively by MCU for sending commands or configurations.  
   - Unified format with fixed starting byte `0xA5`.  

2. **Response Packets**  
   - Generated by RPLIDAR after receiving requests, based on command type.  
   - Can be divided into the following three categories:  
     - Start Response Packets  
     - Data Response Packets  
     - No Response  

---

## 3. Three Communication Modes

| Mode | Trigger Method | Response Feature | Purpose |
|------|------------|------------|------|
| Single Request - Single Response | MCU sends query commands | RPLIDAR replies with one response packet | Query device info, health status |
| Single Request - Multiple Responses | MCU sends sampling commands | RPLIDAR continuously sends ranging data | Scan sampling (SCAN / EXPRESS_SCAN) |
| Single Request - No Response | Control commands | No return, only execute action | STOP, RESET |

> ⚠️ RPLIDAR does not support parallel commands:
> If the previous command has not completed its response, new commands should not be sent, otherwise they may be discarded.

---

## 4. Request Packet Format (MCU → RPLIDAR)

All commands start with `0xA5`. Packet structure:

| Field | Length | Example | Description |
|--------|---------|-----------|-----------|
| Start Flag | 1 | 0xA5 | Fixed value |
| Command Byte | 1 | 0x20 (SCAN) | Indicates command type |
| Payload Length | 1 | 0x05 (if any) | Optional field |
| Payload Data | 0–255 | Multiple bytes | Varies by command |
| Checksum | 1 | XOR value | XOR of all previous bytes |

### Checksum Calculation Method
```
checksum = 0 ⊕ 0xA5 ⊕ CmdType ⊕ PayloadSize ⊕ Payload[0] ⊕ ... ⊕ Payload[n]
```

### Transmission Timing Requirements
Complete request packets **must be sent within 5 seconds**. If timeout, RPLIDAR protocol stack will discard the request.

---

## 5. Response Packet Mechanism (RPLIDAR → MCU)

### 1. Start Response Packet (Fixed Length 7 bytes)

| Field | Length | Example | Description |
|-------|---------|----------|----------|
| Start Flag 1 | 1 | 0xA5 | Fixed |
| Start Flag 2 | 1 | 0x5A | Fixed |
| Data Length | 4 | 0x00000005 | Length of subsequent data frames (30 bits) |
| Mode Field | 2 bits | 0x01 | Indicates multiple response mode |
| Data Type | 1 | 0x81 | Identifies data content type |

**Mode Field Definition**:

| Value | Mode Description |
|----|------------|
| 0x0 | Single Response Mode |
| 0x1 | Multiple Response Mode |
| 0x2~0x3 | Reserved |

### 2. Data Response Packets
Have different formats depending on the command.  
For example:  
- `SCAN` mode: 5 bytes per point  
- `EXPRESS_SCAN` mode: 84 bytes per frame  

---

## 6. Scan Sampling Communication Process

1. **Enter Scan Mode**  
   - MCU sends `SCAN (0x20)` or `EXPRESS_SCAN (0x82)` command.  
   - RPLIDAR replies with start response frame (`0xA5 0x5A ...`).  
   - After motor speed stabilizes, begins continuous sampling data transmission.  

2. **Exit Scan Mode**  
   - MCU sends `STOP (0x25)` → No response, delay ≥10ms.  
   - Or sends `RESET (0x40)` → No response, delay ≥500ms.  

---

## 7. SCAN Mode Data Format

### Each Sampling Point Data Frame (5 bytes)

| Offset | Field | Bit Description | Description |
|------|--------|----------|------|
| 0 | Quality + S + S' + C | S=1 indicates new circle start; S'=!S; C always 1 | Start and check bits |
| 1~2 | angle_q6 | Fixed-point angle value: actual angle=angle_q6/64° |
| 3~4 | distance_q2 | Fixed-point distance value: actual distance=distance_q2/4 mm |

**Frame Synchronization Features**:
- `S` and `S'` are mutually inverted.  
- `C` is always 1.  
- The first frame (S=1) represents the 360° scan starting point.

---

## 8. EXPRESS_SCAN Mode Data Format

### Data Frame Structure (84 bytes)

| Field | Length | Description |
|-------|--------|--------|
| sync1 | 1 | Fixed 0xA |
| sync2 | 1 | Fixed 0x5 |
| ChkSum | 1 | XOR from start_angle_q6 |
| start_angle_q6 | 2 | Starting angle (q6 fixed-point, unit °) |
| S | 1 bit | New circle scan flag |
| Cabin[0~39] | 2 × 40 | Each Cabin contains one distance sample |

### Angle Calculation

```
θk = ωi + (AngleDiff(ωi, ωi+1) / 40) * k
AngleDiff(ωi, ωi+1) = ωi+1 - ωi (if ωi ≤ ωi+1)
                    = 360 + ωi+1 - ωi (if ωi > ωi+1)
```

### Checksum
```
ChkSum = XOR(start_angle_q6[7:0] → last byte)
```

---

## 9. Communication Exceptions and Status Management

| Exception Type | Manifestation | Handling Method |
|-----------|-------|-----------|
| Communication Timeout | MCU did not complete command within 5 seconds | Discard request, resend |
| Frame Misalignment | Data frame parsing error | Find frame header or S/S' to restore sync |
| Data Packet Loss | UART buffer insufficient | Enable DMA+double buffer reception |
| Radar Shutdown | status=2 (protection mode) | Send RESET and delay 500ms |
| No Output | No SCAN sent / baud rate error | Check commands and UART parameters |

---

## 10. Timing Recommendations

| Operation | Minimum Wait Time | Description |
|------|----------------|------|
| After STOP command | 10 ms | Wait for radar to exit scan state |
| After RESET command | 500 ms | Wait for radar to complete soft restart |
| Command send cycle | ≥ 5 s | Prevent timeout packet loss |
| Receive interrupt response | < 0.5 ms | Ensure no data overflow at 460800bps |

---

## 11. Data Flow Characteristics

- In `SCAN` mode, each sampling point is 5 bytes. Typical frequency 4.6k~16kHz.  
- In `EXPRESS_SCAN` mode, each frame is 84 bytes, corresponding to 40 sampling points, frame rate about 200~400 Hz.  
- Data is continuous with no gaps; MCU must read in real-time or use DMA.  

---

## 12. Typical Commands and Response Table

| Command Name | Value | Response Mode | Description |
|-----------|-----|-------------|------|
| STOP | 0x25 | No Response | Stop scanning |
| RESET | 0x40 | No Response | Radar soft restart |
| SCAN | 0x20 | Multiple Response | Standard scan sampling |
| EXPRESS_SCAN | 0x82 | Multiple Response | High-speed sampling |
| GET_INFO | 0x50 | Single Response | Get device info |
| GET_HEALTH | 0x52 | Single Response | Get device health status |

---

## 13. Communication Security and Debugging Recommendations

1. **Baud rate fixed at 460800bps**, recommend MCU clock accuracy error < ±1%.  
2. **Request and response must strictly correspond one-to-one**, no parallel command sending.  
3. **Recommend using DMA + UART idle interrupt (IDLE) reception mechanism** to prevent data overflow.  
4. **Check device health status before each scan start**:  
   - `GET_HEALTH` → If error code=2 → Send `RESET`.  
5. **If judging rotation speed**: Record time difference ΔT between two S=1 frames → RPM = 60 / ΔT.  
6. **During initial debugging** monitor UART waveform with logic analyzer to confirm `0xA5 0x5A` frame header sync is correct.  

---

## 14. Summary

- RPLIDAR uses strictly defined binary communication protocol.  
- MCU must follow command rhythm and timing; any premature, parallel, or timeout may cause communication failure.  
- Stable reception of scan data depends on:  
  - **DMA reception mechanism under high baud rate (460800bps)**  
  - **Frame sync verification logic (S/S', ChkSum)**  
  - **Reliable status management (STOP, RESET, HEALTH check)**  

---

**© 2025 Technical Summary for STM32F466 & RPLIDAR Integration**
